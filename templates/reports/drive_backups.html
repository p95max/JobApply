{% extends "base.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 920px;">

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Cloud backups</h1>
      <div class="text-muted small">Powered by Google Drive</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'reports:statistics' %}">üìä Statistics</a>
      <a class="btn btn-outline-secondary" href="{% url 'reports:import' %}">‚¨Ü Local import/export</a>
    </div>
  </div>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="row g-3">

    <!-- Connection card -->
    <div class="col-12 col-lg-5">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="fw-semibold mb-1">Connection</div>
          <div class="text-muted small mb-3">
            Permission scope: <span class="font-monospace">drive.file</span> (only files created by this app).
          </div>
          {% if drive_status.connected %}
          <div class="text-muted small mb-2">
            Connected as:
            <span class="fw-semibold">{{ google_email|default:request.user.email }}</span>
          </div>
        {% endif %}

        {% if folder_url %}
          <a class="btn btn-outline-secondary w-100 mb-2" href="{{ folder_url }}" target="_blank" rel="noopener">
            üìÅ Open Drive folder
          </a>
        {% endif %}


          {% if not drive_status.connected %}
            <div class="alert alert-warning" role="alert">
              Drive is not connected.
            </div>

            <a class="btn btn-warning w-100" href="{% url 'reports:drive_connect' %}">
              Enable Drive backups
            </a>

          {% else %}
            {% if drive_status.has_refresh_token %}
              <div class="alert alert-success" role="alert">
                Status: Google Drive connected.
              </div>

              <div class="d-grid gap-2">
                <a class="btn btn-outline-danger" href="{% url 'reports:drive_disconnect' %}">
                  Disconnect
                </a>
              </div>

            {% else %}
              <div class="alert alert-warning" role="alert">
                Connected, but offline access is missing. Backups may fail after the session expires.
              </div>

              <div class="d-grid gap-2">
                <a class="btn btn-warning" href="{% url 'reports:drive_connect' %}">
                  Reconnect to enable offline access
                </a>
                <a class="btn btn-outline-danger" href="{% url 'reports:drive_disconnect' %}">
                  Disconnect
                </a>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Backups card -->
    <div class="col-12 col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
            <div class="fw-semibold">Backups</div>

            {% if drive_status.connected and drive_status.has_refresh_token %}
              <div class="d-flex gap-2">
                <a class="btn btn-primary btn-sm" href="{% url 'reports:drive_export' 'csv' %}">
                  ‚òÅ Upload CSV
                </a>
                <a class="btn btn-primary btn-sm" href="{% url 'reports:drive_export' 'xlsx' %}">
                  ‚òÅ Upload XLSX
                </a>
              </div>
            {% endif %}
          </div>

          {% if not drive_status.connected %}
            <div class="alert alert-secondary mb-0">
              Connect Google Drive to start uploading backups.
            </div>

          {% elif not drive_status.has_refresh_token %}
            <div class="alert alert-secondary mb-0">
              Reconnect to enable offline access, then backups will work reliably.
            </div>

          {% else %}
            {% if backups %}
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>File</th>
                      <th class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for f in backups %}
                      <tr>
                        <td>
                          <div class="fw-semibold">{{ f.name }}</div>
                          <div class="text-muted small">{{ f.mime_type }}</div>
                        </td>
                        <td class="text-end">
                          <a class="btn btn-sm btn-outline-primary" href="{% url 'reports:drive_restore' f.file_id %}">
                            Restore
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-secondary mb-0">No backups yet.</div>
            {% endif %}
          {% endif %}

        </div>
      </div>
    </div>

  </div>

</div>
{% endblock %}
