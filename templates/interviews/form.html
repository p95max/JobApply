{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 920px;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">Schedule interview</h1>
      <div class="text-body-secondary small">
        Available applications are filtered to status <span class="badge bg-secondary">Interview</span>.
      </div>
    </div>

    <a class="btn btn-outline-secondary" href="{% url 'interviews:list' %}">
      Back
    </a>
  </div>

  <div class="card border-0 shadow-sm glass-card">
    <div class="card-body p-4">

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <form method="post" novalidate>
        {% csrf_token %}

        <div class="row g-3">
          {% for field in form %}
            <div class="col-12 {% if field.name == 'application' or field.name == 'starts_at' or field.name == 'ends_at' or field.name == 'location' %}col-lg-6{% endif %}">
              <label class="form-label mb-1" for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>

              <div class="form-control-wrap">
                {{ field }}
              </div>

              <div class="form-text min-h-24">
                {% if field.help_text %}
                  {{ field.help_text }}
                {% endif %}
              </div>

              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {{ field.errors|striptags }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="d-flex flex-wrap gap-2 mt-4">
          <button class="btn btn-primary" type="submit">
            Save
          </button>
          <a class="btn btn-outline-secondary" href="{% url 'interviews:list' %}">
            Cancel
          </a>
        </div>
      </form>

      <div class="mt-3 small text-body-secondary">
        Tip: if you don’t see an application in the dropdown — set its status to <span class="text-danger">Interview</span> in Applications.
      </div>

    </div>
  </div>

</div>
{% endblock %}

<!--form fields limits-->
<script>
(function () {
  const fields = document.querySelectorAll("input[data-maxlen], textarea[data-maxlen]");
  if (!fields.length) return;

  function ensureCounter(el) {
    const id = el.id || ("field-" + Math.random().toString(16).slice(2));
    el.id = id;

    let counter = document.querySelector(`[data-counter-for="${id}"]`);
    if (counter) return counter;

    counter = document.createElement("div");
    counter.className = "form-text d-flex justify-content-end mt-1";
    counter.dataset.counterFor = id;

    // place after the field (or after wrapper)
    if (el.parentElement && el.parentElement.classList.contains("form-control-wrap")) {
      el.parentElement.insertAdjacentElement("afterend", counter);
    } else {
      el.insertAdjacentElement("afterend", counter);
    }
    return counter;
  }

  function update(el) {
    const max = parseInt(el.dataset.maxlen, 10);
    if (!max) return;

    const counter = ensureCounter(el);
    const len = (el.value || "").length;

    counter.textContent = `${len} / ${max}`;

    // bootstrap-ish visuals
    el.classList.remove("is-invalid", "is-valid");
    counter.classList.remove("text-danger", "text-warning", "text-body-secondary");

    if (len > max) {
      el.classList.add("is-invalid");
      counter.classList.add("text-danger");
    } else if (len >= Math.floor(max * 0.9)) {
      counter.classList.add("text-warning");
    } else {
      counter.classList.add("text-body-secondary");
      el.classList.add("is-valid");
    }
  }

  fields.forEach((el) => {
    update(el);
    el.addEventListener("input", () => update(el));
    el.addEventListener("change", () => update(el));
  });
})();
</script>